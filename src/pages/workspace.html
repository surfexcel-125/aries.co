<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>Aries · Workspace</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <!-- Global styles -->
    <link rel="stylesheet" href="../styles/design-tokens.css" />
    <link rel="stylesheet" href="../styles/main.css" />
    <link rel="stylesheet" href="../styles/workspace.css" />

    <!-- Dashboard module styles (safe to keep global for now) -->
    <link rel="stylesheet" href="../modules/dashboard/module.css" />
  </head>

  <body class="theme-glass">
    <div class="page-wrapper workspace-page">
      <!-- Workspace frame: header + full-screen module host -->
      <div class="workspace-frame">
        <main class="workspace-main">
          <!-- Slim header: title + module pill + save indicator -->
          <header class="workspace-header-row">
            <div class="workspace-header-main">
              <h1 class="workspace-page-title" id="workspace-title">
                Workspace
              </h1>
            </div>

            <div class="workspace-header-actions">
              <span
                class="workspace-header-badge"
                id="workspace-module-pill"
              ></span>

              <span
                class="workspace-save-indicator"
                id="workspace-save-indicator"
              >
                Idle
              </span>
            </div>
          </header>

          <!-- Full-screen module host -->
          <section id="workspace-root" class="workspace-root"></section>
        </main>
      </div>
    </div>

    <!-- Workspace module loader -->
    <script type="module">
      import '../core/app.js'; // auth guard + sidebar wiring

      console.log('WORKSPACE PAGE LOADED');

      // Labels for nicer header text
      // Keys here must match modules-sdk.js keys:
      // dashboard, mindmap, flowchart, wireframes, task-board, ui-mockups, business, concept, notes, snapshots
      const MODULE_INFO = {
        flowchart: {
          label: 'Flowchart',
          subtitle: 'Map processes, decisions, and outcomes visually.',
        },
        'task-board': {
          label: 'Task Board',
          subtitle: 'Track tasks across backlog, doing, review, and done.',
        },
        mindmap: {
          label: 'Mind Map',
          subtitle: 'Explore and connect ideas in a radial map.',
        },
        wireframes: {
          label: 'Wireframes',
          subtitle: 'Rough UX layouts for pages and screens.',
        },
        'ui-mockups': {
          label: 'UI Mockups',
          subtitle: 'High-level UI mockups with layout and components.',
        },
        dashboard: {
          label: 'Dashboard',
          subtitle: 'Metrics and snapshots for your project.',
        },
        business: {
          label: 'Business Model',
          subtitle: 'Capture problem, solution, channels, and revenue.',
        },
        concept: {
          label: 'Concept Board',
          subtitle: 'Clarify the core concept and value proposition.',
        },
        notes: {
          label: 'Notes',
          subtitle: 'Freeform notes, decisions, and meeting logs.',
        },
        snapshots: {
          label: 'Snapshots',
          subtitle: 'Capture states of your workspace over time.',
        },
      };

      // Map module keys -> module folder names under /src/modules/<folder>/module.js
      const MODULE_TO_FOLDER = {
        flowchart: 'flowchart',
        mindmap: 'mindmap',
        dashboard: 'dashboard',
        business: 'business',
        concept: 'concept',
        notes: 'notes',
        snapshots: 'snapshots',
        'task-board': 'kanban',
        'ui-mockups': 'uimock',
        wireframes: 'wireframe',
      };

      const root = document.getElementById('workspace-root');
      const titleEl = document.getElementById('workspace-title');
      const pillEl = document.getElementById('workspace-module-pill');
      const saveIndicatorEl = document.getElementById(
        'workspace-save-indicator',
      );

      const params = new URLSearchParams(window.location.search);

      const projectId =
        params.get('projectId') || params.get('id') || 'demo-project';
      const projectName =
        params.get('projectName') || params.get('project') || 'Untitled Project';
      const moduleName = params.get('module') || 'flowchart';

      const moduleInfo = MODULE_INFO[moduleName] || {
        label: moduleName,
        subtitle: '',
      };

      // Header text (no breadcrumb, no subtitle)
      if (titleEl) {
        titleEl.textContent = `${moduleInfo.label} · ${projectName}`;
      }
      if (pillEl) {
        pillEl.textContent = moduleInfo.label;
      }

      // Storage key (per project + module)
      const storageKey = `aries.workspace.${projectId}.${moduleName}`;

      const api = {
        async load() {
          try {
            const raw = localStorage.getItem(storageKey);
            if (!raw) return null;
            return JSON.parse(raw);
          } catch (err) {
            console.warn('Failed to load module state', err);
            return null;
          }
        },
        async save(data) {
          try {
            localStorage.setItem(storageKey, JSON.stringify(data));
            showSaving();
          } catch (err) {
            console.warn('Failed to save module state', err);
          }
        },
      };

      let saveTimer = null;
      function showSaving() {
        if (!saveIndicatorEl) return;
        saveIndicatorEl.textContent = 'Saved';
        saveIndicatorEl.classList.add('workspace-save-indicator--saving');
        if (saveTimer) clearTimeout(saveTimer);
        saveTimer = setTimeout(() => {
          saveIndicatorEl.textContent = 'Idle';
          saveIndicatorEl.classList.remove('workspace-save-indicator--saving');
        }, 1200);
      }

      const projectMeta = {
        id: projectId,
        name: projectName,
        module: moduleName,
      };

      (async () => {
        try {
          const folder = MODULE_TO_FOLDER[moduleName] || moduleName;
          console.log('Importing module:', moduleName, '-> folder:', folder);

          // Dynamic module import: /src/modules/<folder>/module.js
          const mod = await import(
            `../modules/${folder}/module.js?cb=${Date.now()}`
          );
          console.log(`Module "${moduleName}" loaded`, mod);

          const savedData = await api.load();

          if (typeof mod.default === 'function') {
            const instance = await mod.default(root, projectMeta, savedData, api);
            window.currentModuleInstance = instance || null;
          } else {
            root.textContent = 'Module loaded but has no default export.';
          }
        } catch (err) {
          console.error('Failed to load module', moduleName, err);
          root.textContent = 'Failed to load module.';
        }
      })();
    </script>
  </body>
</html>
