<!-- project_details.html — Ready to replace -->
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Project Details · Master Workspace</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />

  <!-- from /src/pages/project_details.html to /src/styles/main.css -->
  <link rel="stylesheet" href="../styles/main.css">

  <style>
    :root{ --card-bg:#fff; --muted:#6b7280; }
    body{ margin:0; font-family:Inter,system-ui,Arial; background:#f6f7fb; color:#0b1220; }
    .container{ max-width:1100px; margin:28px auto; padding:20px; }
    .top{ display:flex; justify-content:space-between; gap:12px; align-items:center; margin-bottom:18px; }
    .title{ font-size:20px; font-weight:700; }
    .subtitle{ color:var(--muted); font-size:13px; margin-top:6px; }
    .controls{ display:flex; gap:8px; align-items:center; }
    .mw-btn{ padding:8px 12px; border-radius:10px; background:#0ea5a4; color:white; border:0; cursor:pointer; font-weight:600; }
    .grid{ display:grid; grid-template-columns: 1fr 340px; gap:16px; align-items:start; }
    .main-card{ background:var(--card-bg); border-radius:12px; padding:16px; box-shadow:0 12px 36px rgba(10,20,40,0.06); }
    .modules-list{ display:flex; gap:8px; flex-wrap:wrap; margin-bottom:12px; }
    .mod-btn{ padding:8px 10px; border-radius:8px; cursor:pointer; border:1px solid #e6eef0; background:white; }
    .mod-btn.active{ background:#e6fffb; border-color:#aee9e3; }
    .preview{ min-height:380px; background:var(--card-bg); border-radius:10px; padding:12px; overflow:auto; }
    .meta{ color:var(--muted); font-size:13px; margin-top:8px; }
    .side-panel{ display:flex; flex-direction:column; gap:12px; }
    pre.json{ white-space:pre-wrap; word-break:break-word; font-size:13px; color:#0b1220; background:#fbfdfe; padding:12px; border-radius:8px; border:1px solid #eef6f6; }
    .small{ font-size:13px; color:var(--muted); }
    svg.preview-svg{ width:100%; height:360px; display:block; background:linear-gradient(180deg,#ffffff,#fbfbff); border-radius:8px; }
    @media (max-width:980px){ .grid{ grid-template-columns:1fr; } .side-panel{ order:2 } }
  </style>
</head>
<body>
  <div id="header-fragment"></div>

  <div class="page-wrapper">
    <div class="container">
      <div class="top">
        <div>
          <div class="title" id="projectTitle">Loading…</div>
          <div class="subtitle" id="projectDesc"></div>
        </div>
        <div class="controls">
          <button id="openWorkspace" class="mw-btn mw-disabled" title="Sign in to edit">Open Workspace (Edit)</button>
          <!-- back to projects in same folder /src/pages/ -->
          <a id="openProjects" class="small" href="projects.html">Back to Projects</a>
        </div>
      </div>

      <div class="grid">
        <div class="main-card">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div>
              <div class="small">Preview the built workspace (read-only)</div>
              <div style="margin-top:10px">
                <div class="modules-list" id="modulesList"></div>
              </div>
            </div>
            <div class="small meta" id="updatedMeta">—</div>
          </div>

          <div style="margin-top:12px" class="preview" id="previewHost">
            <div class="small" id="previewHint">Select a module to preview its built content.</div>
          </div>
        </div>

        <div class="side-panel">
          <div class="main-card">
            <div style="font-weight:700">Project Info</div>
            <div class="meta" id="projectMeta"></div>
            <div style="margin-top:12px">
              <div class="small">Project ID</div>
              <div class="small" id="pid"></div>
            </div>
          </div>

          <div class="main-card">
            <div style="font-weight:700">Quick actions</div>
            <div style="margin-top:10px; display:flex; gap:8px; flex-direction:column;">
              <button id="downloadAllJson" class="mw-btn">Download All Module JSON</button>
              <button id="printPreview" class="mw-btn" style="background:#1e293b">Print Preview</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div id="sidebar-fragment"></div>

  <!-- include shared header + sidebar layouts from /src/layouts/ -->
  <script type="module">
    async function includeFragment(url,target){
      try{
        const r = await fetch(url);
        if(r.ok) document.getElementById(target).innerHTML = await r.text();
      }catch(e){}
    }
    includeFragment('../layouts/header.html','header-fragment');
    includeFragment('../layouts/sidebar.html','sidebar-fragment');
  </script>

  <script type="module">
    // use shared Firebase config + v9 SDK (same as rest of app)
    import { auth, db } from '../core/firebase-config.js';
    import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
    import { doc, getDoc } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";
    import '../core/app.js'; // sidebar wiring, overlay, etc.

    // DOM refs
    const titleEl = document.getElementById('projectTitle');
    const descEl = document.getElementById('projectDesc');
    const modulesListEl = document.getElementById('modulesList');
    const previewHost = document.getElementById('previewHost');
    const previewHint = document.getElementById('previewHint');
    const updatedMeta = document.getElementById('updatedMeta');
    const projectMeta = document.getElementById('projectMeta');
    const pidEl = document.getElementById('pid');
    const openWorkspace = document.getElementById('openWorkspace');
    const downloadAllJson = document.getElementById('downloadAllJson');
    const printPreview = document.getElementById('printPreview');

    let currentUser = null;
    let authReadyResolve;
    const authReady = new Promise(resolve => { authReadyResolve = resolve; });

    onAuthStateChanged(auth, user => {
      currentUser = user;
      if (user) {
        openWorkspace.classList.remove('mw-disabled');
        openWorkspace.title = '';
      } else {
        openWorkspace.classList.add('mw-disabled');
        openWorkspace.title = 'Sign in to edit';
      }
      authReadyResolve();
    });

    const MODULES = [
      { key: "dashboard", label: "Dashboard" },
      { key: "mindmap", label: "Mind Map" },
      { key: "concept", label: "Concept Map" },
      { key: "flowchart", label: "Flowchart" },
      { key: "wireframe", label: "Wireframes" },
      { key: "uimock", label: "UI Mockups" },
      { key: "business", label: "Business Plan" },
      { key: "kanban", label: "Task Board" },
      { key: "notes", label: "Notes" },
      { key: "snapshots", label: "Snapshots" }
    ];

    // parse projectId and guard
    const params = new URLSearchParams(location.search);
    const projectId = params.get('projectId');
    if (!projectId) {
      alert('projectId missing');
      // back to /src/pages/projects.html
      location.href = 'projects.html';
    }
    pidEl.textContent = projectId;

    async function loadModuleDoc(key){
      try {
        const docId = `${projectId}__${key}`;
        const ref = doc(db, 'modules_data', docId);
        const s = await getDoc(ref);
        if (!s.exists()) return null;
        return s.data()?.payload ?? null;
      } catch(e) {
        console.warn(e);
        return null;
      }
    }

    async function loadProject(){
      try {
        const ref = doc(db,'projects',projectId);
        const s = await getDoc(ref);
        if (!s.exists()) {
          alert('Project not found');
          location.href = 'projects.html';
          return;
        }
        const p = { id: s.id, ...s.data() };
        titleEl.textContent = p.name || 'Untitled Project';
        descEl.textContent = p.description || '';
        projectMeta.innerHTML = `
          <div class="small">Owner: ${p.ownerId || '—'}</div>
          <div class="small">Tags: ${(p.tags || []).join(', ')}</div>
        `;
        updatedMeta.textContent = p.updatedAt
          ? `Updated ${new Date(p.updatedAt.seconds * 1000).toLocaleString()}`
          : '';

        // If you want to restrict "Open Workspace" to owner only, uncomment below:
        // if (currentUser && p.ownerId !== currentUser.uid) {
        //   openWorkspace.classList.add('mw-disabled');
        //   openWorkspace.title='Only owner can edit';
        // }
      } catch(e){
        console.error(e);
      }
    }

    async function renderModulesList(){
      modulesListEl.innerHTML = '';
      for (const m of MODULES){
        const btn = document.createElement('button');
        btn.className = 'mod-btn';
        btn.innerText = m.label;
        btn.onclick = async ()=> { selectModule(m.key, m.label, btn); };
        modulesListEl.appendChild(btn);
      }
    }

    const payloadCache = {};

    async function selectModule(moduleKey, label, btnEl){
      for (const n of modulesListEl.children) n.classList.remove('active');
      btnEl.classList.add('active');
      previewHint.style.display = 'none';
      previewHost.innerHTML = `<div style="padding:20px;color:var(--muted)">Loading ${label} preview…</div>`;
      let payload = payloadCache[moduleKey];
      if (!payload) {
        payload = await loadModuleDoc(moduleKey);
        payloadCache[moduleKey] = payload;
      }
      try {
        switch(moduleKey){
          case 'mindmap':   renderMindmapPreview(previewHost, payload);   break;
          case 'flowchart': renderFlowchartPreview(previewHost, payload); break;
          case 'wireframe': renderWireframePreview(previewHost, payload); break;
          case 'business':  renderBusinessPreview(previewHost, payload);  break;
          case 'kanban':    renderKanbanPreview(previewHost, payload);    break;
          case 'notes':     renderNotesPreview(previewHost, payload);     break;
          case 'concept':   renderConceptPreview(previewHost, payload);   break;
          case 'uimock':    renderUIMockPreview(previewHost, payload);    break;
          case 'dashboard': renderDashboardPreview(previewHost, payload); break;
          case 'snapshots': renderSnapshotsPreview(previewHost, payload); break;
          default:          renderGenericJson(previewHost, payload);      break;
        }
      } catch (e) {
        console.error(e);
        renderGenericJson(previewHost, payload);
      }
    }

    // ---------- Preview renderers ----------
    function clearHost(host){ host.innerHTML = ''; }

    function renderGenericJson(host, payload){
      clearHost(host);
      const el = document.createElement('pre');
      el.className = 'json';
      el.textContent = payload
        ? JSON.stringify(payload, null, 2)
        : 'No data saved for this module.';
      host.appendChild(el);
    }

    function renderMindmapPreview(host, payload){
      clearHost(host);
      if (!payload || !payload.nodes) { renderGenericJson(host, payload); return; }
      const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
      svg.setAttribute('class','preview-svg');
      svg.setAttribute('viewBox','0 0 1000 600');
      const gLinks = document.createElementNS('http://www.w3.org/2000/svg','g');
      if (payload.links && payload.links.length){
        for (const l of payload.links){
          const n1 = payload.nodes.find(n=>n.id===l.fromId);
          const n2 = payload.nodes.find(n=>n.id===l.toId);
          if (!n1 || !n2) continue;
          const x1 = (n1.x||0), y1 = (n1.y||0), x2 = (n2.x||0), y2 = (n2.y||0);
          const line = document.createElementNS('http://www.w3.org/2000/svg','line');
          line.setAttribute('x1', x1); line.setAttribute('y1', y1);
          line.setAttribute('x2', x2); line.setAttribute('y2', y2);
          line.setAttribute('stroke','#cbd5e1'); line.setAttribute('stroke-width','2');
          gLinks.appendChild(line);
        }
      }
      svg.appendChild(gLinks);
      const gNodes = document.createElementNS('http://www.w3.org/2000/svg','g');
      for (const n of payload.nodes){
        const x = n.x||100, y = n.y||100;
        const rect = document.createElementNS('http://www.w3.org/2000/svg','rect');
        rect.setAttribute('x', x-60); rect.setAttribute('y', y-18);
        rect.setAttribute('rx',8); rect.setAttribute('ry',8);
        rect.setAttribute('width',120); rect.setAttribute('height',36);
        rect.setAttribute('fill','#fff'); rect.setAttribute('stroke','#cbd5e1');
        const text = document.createElementNS('http://www.w3.org/2000/svg','text');
        text.setAttribute('x', x); text.setAttribute('y', y+5);
        text.setAttribute('text-anchor','middle'); text.setAttribute('font-size','12');
        text.setAttribute('fill','#0b1220');
        text.textContent = (n.text||'node').slice(0,24);
        gNodes.appendChild(rect); gNodes.appendChild(text);
      }
      svg.appendChild(gNodes);
      host.appendChild(svg);
    }

    function renderFlowchartPreview(host, payload){
      clearHost(host);
      if (!payload || !payload.nodes) { renderGenericJson(host, payload); return; }
      const svg = document.createElementNS('http://www.w3.org/2000/svg','svg');
      svg.setAttribute('class','preview-svg');
      svg.setAttribute('viewBox','0 0 1200 700');

      for (const ln of (payload.links||[])){
        const a = payload.nodes.find(n=>n.id===ln.from);
        const b = payload.nodes.find(n=>n.id===ln.to);
        if (!a || !b) continue;
        const x1 = a.x||100, y1 = a.y||100, x2 = b.x||300, y2 = b.y||300;
        const path = document.createElementNS('http://www.w3.org/2000/svg','line');
        path.setAttribute('x1', x1); path.setAttribute('y1', y1);
        path.setAttribute('x2', x2); path.setAttribute('y2', y2);
        path.setAttribute('stroke','#cbd5e1'); path.setAttribute('stroke-width','2');
        svg.appendChild(path);
      }

      for (const n of payload.nodes){
        const x = n.x||100, y = n.y||100, w=120, h=48;
        const rect = document.createElementNS('http://www.w3.org/2000/svg','rect');
        rect.setAttribute('x', x - w/2); rect.setAttribute('y', y - h/2);
        rect.setAttribute('rx','8'); rect.setAttribute('ry','8');
        rect.setAttribute('width', w); rect.setAttribute('height', h);
        rect.setAttribute('fill','#fff'); rect.setAttribute('stroke','#cbd5e1');
        const text = document.createElementNS('http://www.w3.org/2000/svg','text');
        text.setAttribute('x', x); text.setAttribute('y', y+6);
        text.setAttribute('text-anchor','middle'); text.setAttribute('font-size','12');
        text.setAttribute('fill','#0b1220');
        text.textContent = (n.label||n.name||'').slice(0,28);
        svg.appendChild(rect); svg.appendChild(text);
      }
      host.appendChild(svg);
    }

    function renderWireframePreview(host, payload){
      clearHost(host);
      if (!payload || !payload.components) { renderGenericJson(host, payload); return; }
      const frame = document.createElement('div');
      frame.style.minHeight = '360px';
      frame.style.borderRadius='8px';
      frame.style.padding='12px';
      frame.style.background='#fff';
      frame.style.display='grid';
      frame.style.gridTemplateColumns='1fr';
      frame.style.gap='8px';
      for (const c of payload.components){
        const el = document.createElement('div');
        el.style.border = '1px dashed #e6eef0';
        el.style.borderRadius='8px';
        el.style.padding='10px';
        el.style.background='#fafcff';
        el.innerHTML = `
          <div style="font-weight:700;font-size:13px">${c.type || 'component'}</div>
          <div class="small">${
            (c.props && c.props.placeholder)
              ? c.props.placeholder
              : (c.type+' — placeholder')
          }</div>`;
        frame.appendChild(el);
      }
      host.appendChild(frame);
    }

    function renderBusinessPreview(host, payload){
      clearHost(host);
      if (!payload || !payload.blocks) { renderGenericJson(host, payload); return; }
      const grid = document.createElement('div');
      grid.style.display='grid';
      grid.style.gridTemplateColumns='repeat(2,1fr)';
      grid.style.gap='8px';
      for (const key of Object.keys(payload.blocks)){
        const card = document.createElement('div');
        card.className = 'main-card';
        card.style.padding='10px';
        const h = document.createElement('div');
        h.style.fontWeight='700';
        h.textContent = key;
        const t = document.createElement('div');
        t.className='small';
        t.style.marginTop='8px';
        t.textContent = payload.blocks[key];
        card.appendChild(h);
        card.appendChild(t);
        grid.appendChild(card);
      }
      host.appendChild(grid);
    }

    function renderKanbanPreview(host, payload){
      clearHost(host);
      if (!payload || !payload.columns) { renderGenericJson(host, payload); return; }
      const wrapper = document.createElement('div');
      wrapper.style.display='flex';
      wrapper.style.gap='8px';
      wrapper.style.overflowX='auto';
      for (const col of payload.columns){
        const colEl = document.createElement('div');
        colEl.style.minWidth='200px';
        colEl.style.background='#fff';
        colEl.style.borderRadius='8px';
        colEl.style.padding='8px';
        const h = document.createElement('div');
        h.style.fontWeight='700';
        h.textContent = col.label || col.key;
        colEl.appendChild(h);
        if (col.tasks && col.tasks.length){
          for (const t of col.tasks.slice(0,6)){
            const card = document.createElement('div');
            card.style.border = '1px solid #eef6f6';
            card.style.padding='8px';
            card.style.borderRadius='8px';
            card.style.marginTop='8px';
            card.innerHTML = `
              <div style="font-weight:600">${t.title}</div>
              <div class="small">${
                (t.assignee ? 'Assignee: '+t.assignee+' • ' : '')}${t.due||''}
              </div>`;
            colEl.appendChild(card);
          }
        } else {
          const em = document.createElement('div');
          em.className='small';
          em.style.marginTop='8px';
          em.textContent='No tasks';
          colEl.appendChild(em);
        }
        wrapper.appendChild(colEl);
      }
      host.appendChild(wrapper);
    }

    function renderNotesPreview(host, payload){
      clearHost(host);
      if (!payload || !payload.notes) { renderGenericJson(host, payload); return; }
      const container = document.createElement('div');
      container.style.display='flex';
      container.style.gap='12px';

      const list = document.createElement('div');
      list.style.minWidth='260px';

      const editor = document.createElement('div');
      editor.style.flex='1';
      editor.style.background='#fff';
      editor.style.padding='12px';
      editor.style.borderRadius='8px';

      let active = payload.notes[0];

      for (const n of payload.notes){
        const btn = document.createElement('div');
        btn.style.padding='8px';
        btn.style.borderBottom='1px solid #eef6f6';
        btn.style.cursor='pointer';
        btn.innerHTML = `
          <div style="font-weight:700">${n.title||'Untitled'}</div>
          <div class="small">${
            n.updatedAt ? new Date(n.updatedAt).toLocaleString() : ''
          }</div>`;
        btn.onclick = ()=>{ active = n; renderNote(); };
        list.appendChild(btn);
      }

      function renderNote(){
        editor.innerHTML = '';
        const h = document.createElement('div');
        h.style.fontWeight='700';
        h.textContent = active.title || 'Untitled';
        const body = document.createElement('div');
        body.style.marginTop='8px';
        body.innerHTML = renderMarkdownLite(active.content||'');
        editor.appendChild(h);
        editor.appendChild(body);
      }

      renderNote();
      container.appendChild(list);
      container.appendChild(editor);
      host.appendChild(container);
    }

    function renderConceptPreview(host, payload){
      clearHost(host);
      if (!payload || !payload.nodes) { renderGenericJson(host, payload); return; }
      const wrap = document.createElement('div');
      wrap.style.display='flex';
      wrap.style.flexWrap='wrap';
      wrap.style.gap='8px';
      for (const n of payload.nodes){
        const b = document.createElement('div');
        b.style.padding='8px 10px';
        b.style.borderRadius='8px';
        b.style.background='#fff';
        b.style.border = '1px solid #eef6f6';
        b.innerHTML = `
          <div style="font-weight:700">${n.type || 'Node'}</div>
          <div class="small">${n.label||''}</div>`;
        wrap.appendChild(b);
      }
      host.appendChild(wrap);
    }

    function renderUIMockPreview(host, payload){
      clearHost(host);
      if (!payload || !payload.screens) { renderGenericJson(host, payload); return; }
      const list = document.createElement('div');
      for (const s of payload.screens){
        const card = document.createElement('div');
        card.className='main-card';
        card.style.marginBottom='8px';
        card.innerHTML = `
          <div style="font-weight:700">${s.name||'Screen'}</div>
          <div class="small">${(s.components||[]).length} components</div>`;
        list.appendChild(card);
      }
      host.appendChild(list);
    }

    function renderDashboardPreview(host, payload){
      clearHost(host);
      if (!payload) { renderGenericJson(host, payload); return; }
      const grid = document.createElement('div');
      grid.style.display='grid';
      grid.style.gridTemplateColumns='repeat(3,1fr)';
      grid.style.gap='8px';
      for (const m of MODULES){
        const card = document.createElement('div');
        card.className='main-card';
        const header = document.createElement('div');
        header.style.fontWeight='700';
        header.textContent = m.label;
        const detail = document.createElement('div');
        detail.className='small';
        detail.style.marginTop='8px';
        detail.textContent = 'Preview available';
        card.appendChild(header);
        card.appendChild(detail);
        grid.appendChild(card);
      }
      host.appendChild(grid);
    }

    function renderSnapshotsPreview(host, payload){
      clearHost(host);
      renderGenericJson(host, payload);
    }

    function renderMarkdownLite(md){
      if (!md) return '';
      let html = md
        .replace(/\r\n/g,'\n')
        .replace(/^### (.*$)/gim,'<h3>$1</h3>')
        .replace(/^## (.*$)/gim,'<h2>$1</h2>')
        .replace(/^# (.*$)/gim,'<h1>$1</h1>');
      html = html
        .replace(/\*\*(.*?)\*\*/g,'<strong>$1</strong>')
        .replace(/\*(.*?)\*/g,'<em>$1</em>');
      html = html.replace(/\[(.*?)\]\((.*?)\)/g,'<a href="$2" target="_blank">$1</a>');
      html = html.replace(/\n/g,'<br>');
      return html;
    }

    // utilities
    function downloadJson(filename, data){
      const blob = new Blob([JSON.stringify(data, null, 2)], { type:'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    }

    downloadAllJson.addEventListener('click', async ()=>{
      const all = {};
      for (const m of MODULES){
        all[m.key] = await loadModuleDoc(m.key);
      }
      downloadJson(`${projectId}_modules.json`, all);
    });

    printPreview.addEventListener('click', ()=> window.print());

    openWorkspace.addEventListener('click', async ()=> {
      await authReady;
      if (!currentUser) {
        alert('Please sign in to edit this project.');
        return;
      }
      // go to workspace in same folder /src/pages/
      window.location = `workspace.html?projectId=${projectId}`;
    });

    (async function init(){
      await authReady;
      await loadProject();
      await renderModulesList();
      const firstBtn = modulesListEl.querySelector('button');
      if (firstBtn) firstBtn.click();
    })();
  </script>
</body>
</html>
