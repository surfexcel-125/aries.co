<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>Aries · Workspace</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <!-- Global styles -->
    <link rel="stylesheet" href="../styles/design-tokens.css" />
    <link rel="stylesheet" href="../styles/main.css" />
    <link rel="stylesheet" href="../styles/workspace.css" />
    <link rel="stylesheet" href="../modules/dashboard/module.css" />
  </head>

  <body class="theme-glass">
    <div class="page-wrapper workspace-page">
      <div class="workspace-frame">
        <main class="workspace-main">

          <!-- Header -->
          <header class="workspace-header-row">
            <div class="workspace-header-main">
              <h1 class="workspace-page-title" id="workspace-title">Workspace</h1>
            </div>

            <div class="workspace-header-actions">
              <span class="workspace-header-badge" id="workspace-module-pill"></span>
              <span class="workspace-save-indicator" id="workspace-save-indicator">Idle</span>
            </div>
          </header>

          <!-- Module host -->
          <section id="workspace-root" class="workspace-root"></section>
        </main>
      </div>
    </div>

    <script type="module">
      import "../core/app.js";

      const MODULE_INFO = {
        flowchart: { label: "Flowchart", subtitle: "" },
        "task-board": { label: "Task Board", subtitle: "" },
        mindmap: { label: "Mind Map", subtitle: "" },
        wireframes: { label: "Wireframes", subtitle: "" },
        "ui-mockups": { label: "UI Mockups", subtitle: "" },
        dashboard: { label: "Dashboard", subtitle: "" },
        business: { label: "Business Model", subtitle: "" },
        concept: { label: "Concept Board", subtitle: "" },
        notes: { label: "Notes", subtitle: "" },
        snapshots: { label: "Snapshots", subtitle: "" },
      };

      const MODULE_TO_FOLDER = {
        flowchart: "flowchart",
        mindmap: "mindmap",
        dashboard: "dashboard",
        business: "business",
        concept: "concept",
        notes: "notes",
        snapshots: "snapshots",
        "task-board": "kanban",
        "ui-mockups": "uimock",
        wireframes: "wireframe",
      };

      const root = document.getElementById("workspace-root");
      const titleEl = document.getElementById("workspace-title");
      const pillEl = document.getElementById("workspace-module-pill");
      const saveIndicatorEl = document.getElementById("workspace-save-indicator");

      const params = new URLSearchParams(window.location.search);
      const projectId = params.get("projectId") || "demo-project";
      const projectName = params.get("projectName") || "Untitled Project";
      const moduleName = params.get("module") || "flowchart";

      const moduleInfo = MODULE_INFO[moduleName] || { label: moduleName };
      titleEl.textContent = `${moduleInfo.label} · ${projectName}`;
      pillEl.textContent = moduleInfo.label;

      const storageKey = `aries.workspace.${projectId}.${moduleName}`;

      const api = {
        async load() {
          try {
            const raw = localStorage.getItem(storageKey);
            return raw ? JSON.parse(raw) : null;
          } catch {
            return null;
          }
        },
        async save(data) {
          try {
            localStorage.setItem(storageKey, JSON.stringify(data));
            saveIndicatorEl.textContent = "Saved";
            setTimeout(() => (saveIndicatorEl.textContent = "Idle"), 1200);
          } catch {}
        },
      };

      (async () => {
        try {
          const folder = MODULE_TO_FOLDER[moduleName] || moduleName;
          const mod = await import(`../modules/${folder}/module.js?cb=${Date.now()}`);
          const saved = await api.load();

          if (typeof mod.default === "function") {
            await mod.default(root, { id: projectId, name: projectName, module: moduleName }, saved, api);
          } else root.textContent = "Module loaded without default export.";
        } catch (err) {
          console.error(err);
          root.textContent = "Failed to load module.";
        }
      })();
    </script>
  </body>
</html>
